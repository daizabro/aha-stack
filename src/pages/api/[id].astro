---
import { getTodos, writeTodos, type Todo } from "../../todoFileOperations";

export const partial = true;

const handlePutRequest = async (todos: Todo[], id: string) => {
	// フォームデータとJSONの両方に対応
	let complete: boolean;

	try {
		const formData = await Astro.request.formData();
		const completeValue = formData.get("complete");
		complete = completeValue === "on" || completeValue === "true";
	} catch {
		// フォームデータが失敗した場合は現在のcomplete状態を反転
		const currentTodo = todos.find((todo: Todo) => todo.id === Number(id));
		complete = currentTodo ? !currentTodo.complete : false;
	}

	const newTodos = todos.map((todo: Todo) => {
		if (todo.id === Number(id)) {
			return { ...todo, complete };
		}
		return todo;
	});
	writeTodos(newTodos);
	Astro.response.status = 200;
};

const handleDeleteRequest = (todos: Todo[], id: string) => {
	const newTodos = todos.filter((todo: Todo) => todo.id !== Number(id));
	writeTodos(newTodos);
	Astro.response.status = 200;
};

const handlePatchRequest = async (todos: Todo[], id: string) => {
	try {
		const body = await Astro.request.text();
		if (!body || body.trim() === "") {
			throw new Error("Request body is empty");
		}

		let json;
		try {
			json = JSON.parse(body);
		} catch (parseError) {
			console.error("JSON parse error:", parseError);
			throw new Error("Invalid JSON format");
		}

		const title = json.title;
		if (typeof title !== "string") throw new Error("title is not string");

		const newTodos = todos.map((todo: Todo) => {
			if (todo.id === Number(id)) {
				return { ...todo, title: title };
			}
			return todo;
		});
		writeTodos(newTodos);
		Astro.response.status = 200;
	} catch (error) {
		console.error("PATCH request error:", error);
		Astro.response.status = 400;
	}
};

try {
	console.log("あああ");
	const todos = getTodos();

	const requestMethod = Astro.request.method;
	const { id } = Astro.params;
	if (!id) throw new Error("id is not defined");

	switch (requestMethod) {
		case "PUT":
			await handlePutRequest(todos, id);
			break;
		case "DELETE":
			handleDeleteRequest(todos, id);
			break;
		case "PATCH":
			await handlePatchRequest(todos, id);
			break;
		default:
			Astro.response.status = 405;
			throw new Error("Method not allowed");
	}
} catch (error) {
	console.error(error);
}
---
