---
import { getTodos, writeTodos, type Todo } from "./todoFileOperations";
export const partial = true;

let todos: Todo[] = [];

try {
	// 現在のTODOリストを取得
	todos = getTodos();

	const requestMethod = Astro.request.method;
	switch (requestMethod) {
		case "GET":

		// GETの場合は正常処理
			Astro.response.status = 200;
			break;

			case "POST":
			try {
				const formData = await Astro.request.formData();
				const todo = formData.get("todo");

				// todoがstringでない場合はエラー
				if (typeof todo !== "string") throw new Error("todoが文字列ではありません");

				// TODOを追加
				todos.push({
					id: new Date().getTime(),
					title: todo,
					complete: false,
				});
				writeTodos(todos);

				// 正常なレスポンスを返す
				Astro.response.status = 201;
			} catch (formError) {

				// フォームデータの取得に失敗した場合、JSON形式での追加を試みる
				try {
					const body = await Astro.request.text();
					if (!body || body.trim() === '') {
						throw new Error("Request body is empty");
					}

					const jsonData = JSON.parse(body);
					const todo = jsonData.todo;
					if (typeof todo !== "string") throw new Error("todo is not string");

					todos.push({
						id: new Date().getTime(),
						title: todo,
						complete: false,
					});
					writeTodos(todos);
					Astro.response.status = 201;
				} catch (jsonError) {
					console.error("JSON parse error:", jsonError);
					Astro.response.status = 400;
				}
			}
			break;
		default:
			Astro.response.status = 405;
			throw new Error("Method not allowed");
	}
} catch (error) {
	console.error(error);
}
---

{
  todos.length ? (
    <ul>
      {todos.map((todo: Todo) => (
        <li
          x-data=`{editing: false, title: "${todo.title}", id: "${todo.id}"}`
        >
        <div
            hx-target="submit"
            x-show="!editing"
          >
              <input type="hidden" name="id" value={todo.id} />
              <input
                type="checkbox"
                name="complete"
                id=`todo_${todo.id}`
                checked={todo.complete}
                hx-put=`/api/todos/${todo.id}`
                hx-trigger="change"
                hx-target="this"
              />
              <label
                for=`todo_${todo.id}`
                x-text="title">
              </label>
              <button
                x-on:click="editing = true"
              >
                編集
              </button>
              <button
                hx-delete=`/api/todos/${todo.id}`
                hx-target="closest li"
                hx-swap="outerHTML swap:1s"
              >
                削除
              </button>
          </div>
          <div
            hx-target="submit"
            x-show="editing"
            id=`${todo.id}`
            // x-data="{updateTitle(){patchTodo(id, title)}}"
          >
              <input
                type="checkbox"
                checked={todo.complete}
                disabled
              />
              <input
                type="text"
                x-model="title"
              />
              <button
                x-on:click="updateTitle();editing = false"
              >
                更新
              </button>
              <button
                x-on:click="editing = false"
              >
                閉じる
              </button>
          </div>
        </li>
      ))}
    </ul>
//     <script>
//       // @ts-ignore
//       feather.replace();

//       function patchTodo(id: string, title: string) {
// 				console.log(`Updating todo ${id} with title: ${title}`);
//   const url = `/api/todos/${id}`;
//   const data = { title: title };
//   fetch(url, {
//     method: 'PATCH',
//     headers: {
//       'Content-Type': 'application/json',
//     },
//     body: JSON.stringify(data),
//   })
//   .then(response => {
//     if (response.ok) {
//       // 成功時の処理（必要に応じてUIを更新）
//       location.reload(); // またはHTMXでリストを再読み込み
//     } else {
//       throw new Error('Update failed');
//     }
//   })
//   .catch((error) => {
//     console.error('Error:', error);
//   });
// }
//     </script>
  ) : (
    <p>TODOがありません。</p>
  )
}
<p>{todos.length}件のTODO</p>
